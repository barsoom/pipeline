version: 2.1

orbs:
  ruby: circleci/ruby@2.1.1 # https://circleci.com/developer/orbs/orb/circleci/ruby
  heroku: circleci/heroku@2.0.0 # https://circleci.com/developer/orbs/orb/circleci/heroku

jobs:
  test:
    docker:
      - image: cimg/ruby:3.2.3 # NOTE: Keep in sync with Gemfile. https://circleci.com/developer/images/image/cimg/ruby#image-tags
        environment:
          BUNDLE_PATH: vendor/bundle
      - image: redis:6.2.6-alpine # NOTE: Keep in sync with dev.yml
      - image: postgres:14.7-alpine # NOTE: Keep in sync with dev.yml
        environment:
          POSTGRES_USER: postgres
          POSTGRES_HOST_AUTH_METHOD: trust
    environment:
      BUNDLE_PATH: vendor/bundle
    steps:
      - checkout
      - ruby/install-deps
      - run:
          name: "Set up DB"
          command: |
            bundle exec rails db:setup db:migrate
      - run:
          name: "Run tests"
          command: |
            mkdir -p /tmp/test-results
            script/ci/pipeline.sh tests "bundle exec rake"
      - store_test_results:
          path: /tmp/test-results
      - store_artifacts:
          destination: test-results
          path: /tmp/test-results

  prepare_app_image:
    environment:
      APP_NAMES: |
          ci-pipeline
    resource_class: medium
    docker:
      - image: cimg/base:stable
    steps:
      - heroku/install
      - checkout
      - setup_remote_docker:
          version: default
          docker_layer_caching: false

      - run:
          name: "Checking if we should wait on an older build or cancel redundant ones"
          command: script/ci/wait_on_older_build_and_cancel_redundant_ones.sh

      - run:
          name: "Preparing app image"
          command: |
            script/ci/pipeline.sh prepare_image "script/ci/prepare_app_image.sh"


  deploy_to_production:
    resource_class: small
    docker:
      - image: cimg/base:stable
    steps:
      - heroku/install
      - checkout
      - run:
          name: "Checking if we should wait on an older build or cancel redundant ones"
          command: script/ci/wait_on_older_build_and_cancel_redundant_ones.sh
      - run:
          name: "Deploying to production"
          command: |
            script/ci/pipeline.sh deploy_production "script/ci/deploy.sh ci-pipeline"

workflows:
  version: 2
  test_and_deploy:
    jobs:
      - test:
          context: shared-config
      - prepare_app_image:
          context: shared-config
      - deploy_to_production:
          context: shared-config
          requires:
            - test
            - prepare_app_image
          filters:
            branches:
              only:
                - master
